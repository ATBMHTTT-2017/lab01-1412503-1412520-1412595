CREATE ROLE TruongPhong;
CREATE ROLE TruongDuAn;
CREATE ROLE GiamDoc;
CREATE ROLE TruongChiNhanh;
CREATE ROLE NhanVien;

GRANT GiamDoc TO NV0016;
GRANT GiamDoc TO NV0017;
GRANT GiamDoc TO NV0018;
GRANT GiamDoc TO NV0019;
GRANT GiamDoc TO NV0020;

GRANT TruongDuAn TO NV0001;
GRANT TruongDuAn TO NV0002;
GRANT TruongDuAn TO NV0003;
GRANT TruongDuAn TO NV0004;
GRANT TruongDuAn TO NV0005;
GRANT TruongDuAn TO NV0052;
GRANT TruongDuAn TO NV0053;
GRANT TruongDuAn TO NV0054;
GRANT TruongDuAn TO NV0055;
GRANT TruongDuAn TO NV0056;
GRANT TruongDuAn TO NV0057;
GRANT TruongDuAn TO NV0058;
GRANT TruongDuAn TO NV0059;
GRANT TruongDuAn TO NV0060;
GRANT TruongDuAn TO NV0061;

SET ROLE ALL

--DAC giam doc
GRANT SELECT ON QTV.DUAN TO GiamDoc; 
GRANT SELECT ON QTV.PHONGBAN TO GiamDoc; 
GRANT SELECT ON QTV.CHINHANH TO GiamDoc; 
GRANT SELECT ON QTV.CHITIEU TO GiamDoc; 
GRANT SELECT ON QTV.NHANVIEN TO GiamDoc;


--VPD truong du an
GRANT SELECT, INSERT, UPDATE ON CHITIEU TO TruongDuAn;
GRANT SELECT ON DUAN TO TruongDuAn;

CREATE CONTEXT emp_ctx USING set_title_ctx_pkg;
--tao Database Session Context cho cac loai nhan vien
CREATE OR REPLACE PACKAGE set_title_ctx_pkg IS 
   PROCEDURE set_title; 
 END; 
 /
 CREATE OR REPLACE PACKAGE BODY set_title_ctx_pkg IS
   PROCEDURE set_title
   AS 
      title varchar2(20);
      countt INTEGER;
   BEGIN
      SELECT SYS_CONTEXT('USERENV', 'SESSION_USER') INTO title FROM DUAL;
      SELECT COUNT(TRUONGPHONG) INTO countt FROM PHONGBAN WHERE TRUONGPHONG = title;
      IF countt > 0
      THEN
        title := 'TruongPhong';
        DBMS_SESSION.SET_CONTEXT('emp_ctx', 'title', title);
      ELSE
      
        SELECT COUNT(TRUONGCHINHANH) INTO countt FROM CHINHANH WHERE TRUONGCHINHANH = title;
        IF (countt > 0) THEN
           title := 'TruongChiNhanh';
          DBMS_SESSION.SET_CONTEXT('emp_ctx', 'title', title);
        ELSE
          
          SELECT COUNT(TRUONGDA) INTO countt FROM DUAN WHERE TRUONGDA = title;
          IF (countt >0) THEN
            title := 'TruongDuAn';
            DBMS_SESSION.SET_CONTEXT('emp_ctx', 'title', title);
          ELSE
         
            title := 'NhanVien';
            DBMS_SESSION.SET_CONTEXT('emp_ctx', 'title', title);
          END IF;
        END IF;
      END IF;
   EXCEPTION  
    WHEN NO_DATA_FOUND THEN NULL;
  END;
END;
  /
  show errors
 --tao trigger de moi lan logon 1 user nao do, oracle tu dong chay app context de gan title cho user do 
CREATE OR REPLACE TRIGGER set_title_ctx_trig AFTER LOGON ON DATABASE
 BEGIN
  QTV.set_title_ctx_pkg.set_title;
 END;
 /
 show errors
 
 --select SYS_CONTEXT('USERENV', 'SESSION_USER') from DUAL
 --select SYS_CONTEXT('emp_ctx', 'title') from DUAL
 
 ---Trưởng dự án chỉ được phép đọc, ghi thông tin chi tiêu của dự án mình quản lý
 --tao policy function
 CREATE OR REPLACE FUNCTION auth_chitieu_select( 
  schema_var IN VARCHAR2,
  table_var  IN VARCHAR2
 )
 RETURN VARCHAR2
 IS
  return_val VARCHAR2 (500);
  userName VARCHAR2(6);
  title varchar2(20);
  countt integer;
 BEGIN
  SELECT SYS_CONTEXT('emp_ctx', 'title') INTO title FROM DUAL;
  SELECT SYS_CONTEXT('userenv', 'SESSION_USER') INTO userName FROM DUAL;
  IF (title = 'TruongDuAn') THEN
      return_val := 'EXISTS  (SELECT MADA FROM DUAN WHERE MADA = DUAN  AND TRUONGDA = '''  ||  userName || ''' )';
      RETURN return_val;
  END IF;
   RETURN return_val;
 END auth_chitieu_select;
/
 show errors
 
  CREATE OR REPLACE FUNCTION auth_chitieu_insert( 
  schema_var IN VARCHAR2,
  table_var  IN VARCHAR2
 )
 RETURN VARCHAR2
 IS
  return_val VARCHAR2 (500);
  userName VARCHAR2(6);
  title varchar2(20);
  countt integer;
 BEGIN
  SELECT SYS_CONTEXT('emp_ctx', 'title') INTO title FROM DUAL;
  SELECT SYS_CONTEXT('userenv', 'SESSION_USER') INTO userName FROM DUAL;
  IF (title = 'TruongDuAn') THEN
      return_val := 'EXISTS  (SELECT MADA FROM DUAN WHERE MADA = DUAN  AND TRUONGDA = '''  ||  userName || ''' )';
      RETURN return_val;
  END IF;
   RETURN return_val;
 END auth_chitieu_insert;
/
 show errors
 --tao policy
 ---Trưởng dự án chỉ được phép đọc, sửa thông tin chi tiêu của dự án mình quản lý
 BEGIN
  DBMS_RLS.ADD_POLICY (
    object_schema    => 'QTV',
    object_name      => 'CHITIEU',
    policy_name      => 'chitieu_policy',
    function_schema  => 'QTV',
    policy_function  => 'auth_chitieu_select',
    statement_types  => 'select, update'
   );
 END;
 ---Trưởng dự án chỉ được phép ghi thông tin chi tiêu của dự án mình quản lý
 BEGIN
    DBMS_RLS.add_policy('QTV', 'CHITIEU', 'chitieu_policy1', 
                      'QTV', 'auth_chitieu_insert',
                      'INSERT', TRUE);
 END;
/
--EXEC DBMS_RLS.DROP_POLICY('QTV','CHITIEU','chitieu_policy');
 show errors
 
 
 --dang nhap bang tai khoan khac QTV
 SELECT duAn IN (SELECT MADA FROM DUAN WHERE TRUONGDA = 'NV0004')
 SELECT * FROM QTV.CHITIEU
 --SELECT * FROM QTV.DUAN
 INSERT INTO QTV.CHITIEU VALUES('CT027', 'Nhân công', 35000000000, 'DA015')
 UPDATE QTV.CHITIEU SET TENCHITIEU = 'Nhân lực' WHERE DUAN = 'DA015'
-- SELECT VALUE FROM V$DIAG_INFO WHERE NAME = 'Default Trace File';
